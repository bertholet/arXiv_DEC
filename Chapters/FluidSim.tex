\chapter{A Fluid Simulation with DEC}
\label{chap:FS}

\begin{figure}[h]%
\begin{center}
\includegraphics[height = 5cm]{imgs/8_fluidsphereI.eps}%	
\end{center}
\caption{The simulation of a viscous fluid on a sphere with 1920 triangles. Motion was induced by stirring.}%
\label{fig:8_fluidsphere}%
\end{figure}

In this chapter a fluid simulation using DEC is presented, following the approach from Elcott et al. \cite{simplicialFluids}. 
All theory but fluid dynamics has been introduced, so this chapter is a demonstration of DEC in use. 

One of the challenges when simulating fluids is to keep geometric features like incompressibility or vortices. Because of the geometric nature of DEC and because DEC conserves the geometry of the curl and divergence operator, these difficulties drop away. On the other hand simplifying assumptions are taken, and together with the interpolation scheme used, it is not clear how accurate the simulation is. The authors of \cite{simplicialFluids} have taken the pragmatic point of view that their simulation is designed to preserve visually important features of fluids and left thoughts about accuracy for future work. 

%Problem of standard fluid simulations.

%\newpage
\section{Problem Statement}

%\subsection{Properties of Fluids}
%Formally, fluids are described by the Navier Stokes equation in the next section. Viscosity, incompressibility, vorticity.  \note{Todo: The Karman Vortex street. Viscous fluids have an interesting behaviour close to boundaries of non moving objects. As they have internal friction the velocity on the boundaries of such objects is zero. This leads to some vorticity which then are carried away}

%\subsection{Viscosity and Vorticity}

\begin{figure}%
\begin{center}
\includegraphics[height = 3cm]{imgs/7_vortAndVisc.eps}%	
\end{center}
\caption{A parcel without any rotation (1) moves along of the border of an obstacle and picks up vorticity due to the viscosity of the fluid (2). The vorticity then is diffused and slowly decreases, again because of the viscosity of the fluid (3).}%
\label{fig:fd_vortAndVisc}%
\end{figure}

The two features this simulation concentrates on are the viscosity and vorticity of fluids. Viscosity is a measure for the internal friction of a fluid. If a fluid parcel, that is a small, particle-like volume, moves with some speed, the neighboring fluid is affected by friction and dragged along to some extent, while the fluid parcel itself is slowed down. 
Vortices are fluid parcels that have picked up rotation. If a fluid parcel picked up some rotation it keeps rotating when moving along the flow. The rotation is only damped by the internal friction of the fluid. 

In combination with obstacles the viscosity of a fluid also induces new vorticities. If a fluid has internal friction, its velocity on the boundary of static, non-moving obstacle has to be zero. A parcel moving  along an obstacle then picks up vorticity, as depicted in Figure \ref{fig:fd_vortAndVisc}.

Vorticity is measured by the curl of the velocity field. As seen in Section \ref{subsec:geometryCDO},  curl measures how much rotation a velocity field induces locally.

\subsection{Navier Stokes}

The first step is to formulate the behaviour of fluids appropriately with vector calculus and exterior calculus. 
Physics provide the following description of incompressible viscous fluids, the Navier-Stokes equation:
\[\frac{\partial u}{\partial t} + Du \cdot u = -\nabla p + \nu \Delta u,\]
\begin{equation}div(u) = 0\label{eq:NS}.\end{equation} 
The single terms have the following meanings:

\begin{itemize}
	\item $u(x,t)$ is a time and position dependent vector field of velocities. The velocities describe the speed and the direction of 'particles` at fixed positions
	\item The condition $div(u) = 0$ describes that the fluid is incompressible; at every point all incoming flow has to go out. This ensures that the total volume of the fluid is preserved.
	\item $\frac{\partial u}{\partial t} + D u \cdot u$ is the material derivative or derivative along the motion (see Figure \ref{fig:fsmaterialderivative}). The material derivative is based on the idea that you track particles or parcels and compute the change of their velocity. The trajectory $\alpha$ of a particle is defined by:
\[\frac{\partial \alpha(t)}{\partial t} = u(\alpha(t), t)\]
The change of velocity of such a particle can then simply be computed by using the chain rule,  
\begin{align*}\frac{\partial}{\partial t} u(\alpha(t),t) &= Du \cdot \frac{\partial}{\partial t}\begin{pmatrix}
\alpha(t) \\
t
\end{pmatrix}\\
&= (\frac{\partial u}{\partial x}, \frac{\partial u}{\partial y},\frac{\partial u}{\partial z}, \frac{\partial }{\partial t}) \cdot \begin{pmatrix}
u(\alpha(t),t) \\
1
\end{pmatrix} \\
&= \frac{\partial u}{\partial t} + Du \cdot u.
\end{align*}
\item $p(x,t)$ is a scalar field that describes the pressure at the position $x$ at time $t$. The vectors $-\nabla p$ therefore point in the direction of the largest pressure decrease.
\item The factor $\nu \Delta u$ is the diffusion factor and $\nu$ is the viscosity, a real valued material dependent constant. The viscosity $\nu$ describes how 'thick` the fluid is, how much internal friction it has. For example honey is thicker than water and its viscosity $\nu$ is higher; water having a viscosity of $0.001$. The term $\nu \Delta u$ describes that the higher the friction is, the more the velocities get diffused.
\end{itemize}

\begin{figure}%
\begin{center}
\includegraphics[height=3cm]{imgs/7_vfvarying2.eps}%	
\end{center}
\caption{A comparision of the derivative and the derivative along the motion: the velocity field is constant over time and its derivative $\frac{\partial u}{\partial t}$ is zero. But the velocity of a tracked particle changes; the material derivative describes this change.}%
\label{fig:fsmaterialderivative}%
\end{figure}

The Navier-Stokes equation states that the movement of small parcels is influenced by pressure differences and a diffusion term. Every particle is pulled both in the direction of the largest pressure decrease and in a direction such that curl and divergence are decreased (diffusion), where the influence of the diffusion depends on the fluid's viscosity.

\subsubsection{Navier Stokes for Vorticities}
To put an emphasis on the behavior of vortices in the fluid simulation, the authors of \cite{simplicialFluids}  reformulate the Navier Stokes equation in terms of vorticities. You get such a description by applying $\nabla \times$ to both sides of Equation \ref{eq:NS},
\[\nabla \times \frac{\partial u}{ \partial{t}} + \nabla \times (u \cdot \nabla u) = - \underbrace{\nabla\times \nabla}_{=0} p + \nu \nabla \times \Delta u,\]
leading to\footnote{You need to use $\nabla u = 0$ to show the identity $\nabla \times (Du \cdot u) = D w \cdot u - Du \cdot w$ where $w = \nabla \times u$. Also $\nabla \times \Delta u = \Delta (\nabla \times u)$ is used. Both identities are easy to check by writing them out. }:
\begin{equation}\frac{\partial w}{\partial t} + Dw\cdot u - Du \cdot w =  \nu \Delta w,\label{eq:NS2}\end{equation}
\[w = \nabla \times u,\hspace{0.5cm} div(u) = 0.\]
Simulating the curl $\nabla \times u$ of the velocity field instead of the velocities $u$ has benefits. The pressure term disappears. And simulating the curl leads to a better simulation of the vortices. 

The left hand side of Equation \ref{eq:NS2} describes the derivative of curl along the motion, similarly to the derivative of $u$ along the motion that appeared in Equation \ref{eq:NS}. Equation \ref{eq:NS2} therefore states that  vorticity is carried along the flow while being diffused with time. The viscosity $\nu$ controls how fast vorticities get diffused. The extreme is an inviscid fluid, a fluid with no internal friction. There the viscosity is $\nu = 0$ and the derivative of the curl along the motion is 0. Therefore the curl along the motion is constant and vorticities are carried with the flow without ever being diminished.

\subsubsection{Stirring}
To take account of additional forces $F$, for example induced by stirring, the Equations \ref{eq:NS} and \ref{eq:NS2} need to be slightly adapted to
\[\frac{\partial u}{\partial t} + Du \cdot u = -\nabla p + \nu \Delta u + F,\]
such that the change of velocity also depends on $F$. The formulation for vorticities then becomes
\begin{equation}\frac{\partial w}{\partial t} + Dw\cdot u - Du \cdot w =  \nu \Delta w + \nabla \times F \label{eq:NS3},\end{equation}
where $F$ is a vector valued function.

\subsection{A Numerical Integration Scheme}

\begin{figure}[t]
\begin{center}\fbox{\parbox{12cm}{
\emph{
\begin{enumerate}
\item Velocities $u_{t_n}$ are known at time $t_n$
\item Compute vorticity $w_{t_{n+1}}$ at time $t_{n+1}$ at some positions $p'$:
\begin{enumerate}
	\item Backtrack $p'$ according to the velocity field $u_{t_n}$ to the position $p$ it was at time $t_n$
	\item Use $u_{t_n}$ to compute $w_{t_n}(p,t_n)$.
	\item Solve $w_{t_{n+1}}(p',t_{n+1}) = w_{t_n}(p,t_n) + (t_{n+1} - t_n)\Delta w_{t_{n+1}}(p',t_{n+1})$ for $w_{t_{n+1}}(p',t_{n+1})$ to add diffusion.
\end{enumerate}
\item Add forces $\omega_{t_{n+1}} += (t_{n+1}-t_n)\cdot\nabla \times F_{t_{n+1}}$
\item Recover the velocity field $u_{t_{n+1}}$ from the vorticities $w_{t_{n+1}}$.
\end{enumerate}}
}}\end{center}
\caption{The numerical integration scheme.}
\label{fig:fd_numericalIntegration}
\end{figure}


The authors of \cite{simplicialFluids} propose to solve the equation \ref{eq:NS3} for the simulation of the fluid, using what they call a geometric integration scheme. The scheme is a combination of implicit numerical integration and the tracking of particles and mimics the geometric behavior of the flow. Suppose a fluid parcel with space time position $(p',t_{n+1})$ was at the position $(p,t_{n})$ in the timestep before. Then, 
\[\frac{\partial w}{\partial t} + Dw\cdot u - Du \cdot w \approx  \frac{(w(p^\prime,t_{n+1}) - w(p,t_{n}))}{t_{n+1}-t_n},\]  
and inserting this in Equation \ref{eq:NS3} produces
\begin{align}w(p^\prime,t_{n+1}) \approx \;& w(p,t_n) + (t_{n+1}-t_n) \cdot \nu \Delta w(p',t_{n+1}) \nonumber \\ &{}+ (t_{n+1}-t_n) \cdot\nabla \times F_{t_{n+1}}\label{eq:vortDiffusion},\end{align}
where $F_{t_{n+1}}$ are the additional forces at the time $t_{n+1}$. Equation \ref{eq:vortDiffusion}  can be used for numerical integration over time and directly leads to the integration procedure listed in Figure \ref{fig:fd_numericalIntegration}. 

Before we go on describing each of the steps 2-4 in detail, we have to consider the theoretical feasability of step 4.
In step 4 a velocity field needs to be computed from vorticities alone. In general it is not possible to recover a form $\omega$ only from its exterior derivative $d\omega$, as stated by the Poincar\'e Lemma in Section \ref{ssec:vf_poincare}. But using the incompressibility of the fluid and making additional assumptions about the harmonic part of the flow, step 4 can be realized. As this is of a theoretical nature and sets the frame for the implementation of the integration scheme, we cover the background of step 4 in the next subsection, Section \ref{subsec:fd_vort2vel}.
 %We will consider the background for step 4 first, before we chronologically give detailed descriptions of the  steps 1-4 in Section \ref{sec:fd_implementation}. The background of step 4 needs to be clarified first, because it is of a theoretical nature independent of DEC, and sets the frame for the implementation of the integration scheme to some extend.

Once the background of step 4 is clarified, we turn to giving detailed descriptions of the single steps of the integration scheme in Section \ref{sec:fd_implementation}: the steps 2(a) and (b) of the integration scheme are treated in Section \ref{ssec:fd_interpolation_and_PT}, and steps 2(c) and 3 are described in Section \ref{ssec:fd_diffusion_and_forces}. Step 4 decays in two sub steps; the first is the computation of a harmonic flow component, and is treated in Section \ref{ssec:fd_harmonic}. The second is the recovery of the non-harmonic part of the velocity field, and is covered in Section \ref{ssec:fd_recovering_da}.



\subsection{From Vorticities to Velocities}
\label{subsec:fd_vort2vel}

Here we cover the theoretical background of the step 4 in the integration scheme form Figure \ref{fig:fd_numericalIntegration}, but without giving implementation details, cf. Sections \ref{ssec:fd_harmonic} and \ref{ssec:fd_recovering_da}. 

In EC terms, velocities can be represented by a $1$-form $u$ and vorticities by a $2$-form $w$.
 The problem statement from step 4 then is the following: given a $2$-form $w$ we want to solve for a 1-form $u$ such that
\begin{equation*}\left.\begin{aligned}\partial u &= 0 \;\; (incompressibility) \\ 
du &= w \end{aligned}\right\}\end{equation*}
From the Pointcarr\'e Lemma we know that   in general  the problem $\partial u = w$ can not uniquely be solved for $u$. But by using the incompressibility of fluids and making additional assumptions about $u$, $u$ can be computed. 

The first step is to apply the Hodge decomposition theorem to $u$:
\[u = \partial a + db + c, \]
where $c$ is a harmonic 1-form. From the incommpressibility condition $\partial u = 0$, we know that the non divergence free part $db$ needs to be zero.\nobreak
%
\footnote{ We can get this by the usual argument using the no divergence constraint: $0 = \partial u = \partial \partial a + \partial db + \partial c = \partial d b$ and then the adjointness of $d$ and $\partial$: $\partial d b = 0 \Rightarrow \langle \partial d b , b \rangle = 0 \Rightarrow \langle db, db \rangle = 0 \Rightarrow db = 0 $}
%
Therefore the Hodge decomposition simplifies to: 
\[u = \partial a + c.\]
As the harmonic part $c$ fulfils $dc = 0$,
\begin{equation} w = du = d\partial a \label{eq:fd_vort2vel0}.\end{equation}
There is no way to get the harmonic component $c$ out of the vorticities $w$, as $w$ depends only of $a$. This is not astonishing, as by the Hodge decomposition it is orthogonal to vorticities. The harmonic part $c$ of $u$ therefore needs to be computed separately. But from $w = d \partial a$ not even $a$ is well defined. But not all is lost. We are only interested in $\partial a$, and using the adjointness of $d$ and $\partial$ one can show\nobreak 
%
\footnote{If $ d \partial a = d \partial b$, then $d \partial (a- b) = 0$ and therefore, using the adjointness of $d$ and $\partial$, we get $\partial (a-b) = 0.$}
%
\begin{equation}d \partial a = d \partial b \;\;\;\Rightarrow\;\;\; \partial a = \partial b \label{eqn:fd_itDoesNotMatter}.\end{equation}
%
Equation \ref{eqn:fd_itDoesNotMatter} means that it does not matter what $a$ with $w = d \partial a$ is chosen, as, by Equation \ref{eqn:fd_itDoesNotMatter}, the contribution $\partial a$ to the velocities $u$ is the same for all $a$ with $w = d \partial a$. From the Hodge decomposition theorem we also know that we can constrain $da$ independently from $\partial a$, so we can add the constraint $da = 0$ to Equation \ref{eq:fd_vort2vel0} to pick a specific solution $a$. But if $da = 0$, then the term $\partial d a$ is zero too, and we can add $\partial d a$ to Equation \ref{eq:fd_vort2vel0}, getting
\begin{equation} w = d\partial a + \partial d a = \Delta a .\label{eq:fd_vort2vel}\end{equation}
But this is the Poisson problem, which we are able to solve for $a$.

So from the vorticities $w$ we can get the vorticity part $da$ of the velocity field $u$, but not the harmonic part $c$. The authors of \cite{simplicialFluids} simply assume that the harmonic part $c$ is not time dependent and can be computed once and for all from application dependent constraints. We can capture this section in a theorem:

\begin{thm} \label{thm:vort2vel}(Vorticity to Velocity) If the harmonic component $c$ of a $1$-form $u$ is given, the space of forms allows a Hodge decomposition and the operators $d$ and $\partial$ are adjoint, then the system
\begin{equation}\left.\begin{aligned}\partial u &= 0 \;\; (incompressibility) \\ 
du &= w \end{aligned}\right\}\end{equation}
can be solved by finding a solution $a$ of
\[\Delta a = w,\]
and setting
\[u = \partial a + c.\]
\end{thm}

From Section \ref{subsec:vf_dimHarm} we know that, depending on the topology of the manifold, harmonic forms $c$ do not need to exist. Namely on the surface of a sphere there are no harmonic 1-forms. A fluid simulation on the surface of a sphere therefore is less complicated than one on a plane with borders. 

From the Section \ref{sec:EC_EC} where the coderivative was introduced, and the Section \ref{sec:VF_hodgeDecomp} about the Hodge decomposition, we know that on manifolds with borders, the operators $d$ and $\partial$ need not to be adjoint and the Hodge decomposition needs not to hold either. In \cite{FRANKEL11} (p377ff) more general results are mentioned. The Hodge decomposition does for example hold for `tangential' forms, that is forms $\omega$ for which $\star\omega$ restricted to the border $\delta M$ is 0. One example of a tangential form would be $1$-forms represented by vector fields whose vectors are tangential to borders. Tangential forms arise naturally in the fluid simulation setting, as the boundary of the mesh often represents an impenetrable wall through which a fluid cannot flow.


\section{Implementation}
\label{sec:fd_implementation}

We restrict ourselves to simulations of fluids on two dimensional surfaces. There is no difference in the theory or the algorithm when working on three dimensions, but the display of flow that is restricted to two dimensions is simpler. And in two dimensions the fluid simulation can be demonstrated on curved manifolds. 

In the following subsections we work out the details of the integration scheme presented  in Figure \ref{fig:fd_numericalIntegration}.  There are many details that need to be handled correctly for the fluid simulation to work properly. 

In Section \ref{sec:fd_samplingscheme} we describe the sampling scheme used in this application. In comparison to the other applications the sampling schemes of primary forms and dual forms is reversed. This allows the correct enforcement of boundary constraints. In Section \ref{sec:fd_algoverview} we give a graphical overview of the simulation algorithm, and the Sections \ref{ssec:fd_interpolation_and_PT} to \ref{ssec:fd_recovering_da} explain the single steps of the simulation.
Section \ref{ssec:fd_interpolation_and_PT} covers the computation of a \emph{continuous} vector field from a discrete 1-form, as well as the back-tracing step, Section \ref{ssec:fd_diffusion_and_forces} covers the handling of diffusion and the addition of forces, and the Sections \ref{ssec:fd_harmonic} and \ref{ssec:fd_recovering_da} treat the computation of the harmonic component of the flow, as well as the recovery of the velocity field from the vorticities.

%While many steps in the geometric integration scheme in Figure \ref{fig:fd_numericalIntegration} are easy to translate into DEC terms, there are many details that need to be handled correctly for the fluid simulation to work properly. In comparision to the other applications the sampling schemes of discrete primary and dual forms need to be swapped to allow the correct enforcement of boundary constraints. The discrete $1$-form describing velocities needs to be transformed into a \emph{continuous} velocity field and throughout the algorithm the boundary constraints need to be enforced carefully. And the harmonic component of the flow needs to be computed for some border constraints.

\subsection{Sampling Scheme}
\label{sec:fd_samplingscheme}

\begin{figure}%
\includegraphics[width=0.95\columnwidth]{imgs/8_fd_dualpprimalproblem.eps}%
\caption{By switching the roles of the dual and primal mesh vector fields are sampled differently, such that primary edges store \emph{flux}, the flow through them, instead of the flow along them. This results in the operators $d$ and $\partial$ also changing their meaning.}%
\label{fig:fd_whoiswho}%
\end{figure}

To simplify the specification of border constraints, the role of the dual mesh and the primary mesh are switched, such that what we interpreted so far as dual forms are stored on the primary mesh and vice versa.  Primary edges then store the flow through them instead of the flow along them, see also the different sampling schemes from Section \ref{subsec:samplingForms}. As a result of the swap, the operators $d$ and $\partial$ also have  different interpretation in vector calculus, see Figure \ref{fig:fd_whoiswho}. For this application vorticity is stored on vertices as a discrete $0$-form, or equivalently as a discrete dual 2-forms on dual faces. Divergence is stored as a discrete 2-form on triangles.

The changed roles allow to constrain the flow through the boundaries of the mesh. For example the constraint on impenetrable obstacles and walls is that there is no flow across the boundary. If the discrete 1-form $\discrete{u}^1$ represents the velocity form, impenetrability is simply enforced by constraining the flux across the concerned edges to be 0, $\discrete{u}^1(e_{boundary}) = 0$.

Note that changing the roles of the dual and primal mesh is consistent with the remark in Section \ref{subsec:fd_vort2vel}, that tangential forms have the property $\star w |_{\delta M} = 0 $. This can not be enforced on the dual mesh, as the border of the dual mesh is not the geometric border of the mesh. %Therefore the change of roles is necessary.

\subsection{Algorithm Overview}
\label{sec:fd_algoverview}

\begin{figure}%
\begin{center}
\vspace{-0.1cm}
\includegraphics[width=0.95\columnwidth]{imgs/8_algorithm_overview3.eps}%	
\end{center}
\vspace{-0.5cm}
\caption{A schematic representation of one time step of the fluid simulation. The labels refer to the corresponding steps in the integration scheme from Figure \ref{fig:fd_numericalIntegration}, and to the section the step is discussed. The harmonic component \textbf{c} is computed separately during a set up stage.}%
\vspace{-0.3cm}
\label{fig:fd_algorithm}%
\end{figure}

Figure \ref{fig:fd_algorithm} sketches one time step of the algorithm that implements the integration scheme (IS) from Figure \ref{fig:fd_numericalIntegration} designed to solve the equation 
\begin{align*}w(p_{t_{n+1}},t_{n+1}) \approx \;& w(p_{t_n},t_n) + (t_{n+1}-t_n) \cdot \nu \Delta w(p_{t_{n+1}},t_{n+1}) \nonumber \\ &{}+ (t_{n+1}-t_n) \cdot\nabla \times F_{t_{n+1}}.\end{align*}
On a high level, the Algorithm consists of the following elements:

During a set up step a harmonic component $\discrete{c}$ (see Section \ref{ssec:fd_harmonic}) and the dual mesh need to be computed explicitely. The non vorticity free part $d\discrete{a}$ of the velocity field $\discrete{u}$ is initially set to zero and $\discrete{u}$ is set to be the harmonic field $\discrete{c}$. Forces $\discrete{F}$ induced by stirring are captured between time steps, in the same way as strokes are captured in the vector field design application.

A single integration time step consists of the following substeps: first the dual vertices are traced back, using a continuous interpolation of the velocity field $\discrete{u}$, in order to compute the back traced vorticites (IS 2 (a), see Section \ref{ssec:fd_interpolation_and_PT}). %Vorticites are associated to the dual faces. 
The back traced vorticy associated to some dual face is computed by first tracing back the dual face and then summing up the flow of $\discrete{u}$ around the back traced dual face (IS 2 (b), see Section \ref{ssec:fd_interpolation_and_PT}). These vorticities are diffused and the vorticities $\partial \discrete{F}$ of the additional forces $\discrete{F}$ are added to the diffused vorticities (IS steps 2 (c) and 3, see Section \ref{ssec:fd_diffusion_and_forces}). Finally the vorticity part $d\discrete{a}$ of the velocity field $\discrete{u}$ is recovered from the obtained vorticities, and $\discrete{u}$ is updated, using the precomputed harmonic component $\discrete{c}$ (IS step 4, see Section \ref{ssec:fd_recovering_da}).


\subsection{Interpolation and Pathtracing}
\label{ssec:fd_interpolation_and_PT}

The first step in the IS is to backtrace the vorticities. Vorticities are calculated by summing up the flow around dual faces. In order to compute the backtraced vorticities, the dual faces, or more specifically the dual vertices, are backtraced. 

To be able to trace the path of a vertex and to be able to compute the flow around a backtraced dual face, we need a continuous vector field defined on the mesh. Note that the interpolation scheme using Whitney forms described in Section \ref{sec:vf_1form2vf} is not suited, as it does not produce a continuous vector field. Therefore, we first describe how to compute a continuous vector field from a discrete 1-form, then how this field can be used for tracing the path of a particle, and finally how the velocity field is used to compute the vorticity on a backtraced dual face. Logically these are the steps 2 a) and 2 b) of the integration scheme.

\subsubsection{A Continuous Vector Field on the Mesh}

The authors of \cite{simplicialFluids} propose the following interpolation scheme to get a  continuous vector field. First, velocity vectors are computed at the positions of dual vertices; this can be done using the sharp operator from \ref{sec:vf_1form2vf}. A velocity vector at an arbitrary point $p$ on the mesh is then computed by first identifying the dual face the $p$ lies in, i.e. identifying the closest vertex,  and then smoothly interpolating the velocity vectors given on the corners of the dual face.

\begin{figure}%
\begin{center}
\includegraphics[height = 3.5cm]{imgs/8_bariweight.eps}%	
\end{center}
\caption{The baricentric weight function for one vertex in a pentagon, once as shaded surface, once as color plot. Note that the weight is linear on the polygon edges.}%
\label{fig:fd_bariweight}%
\end{figure}

The velocity vectors are interpolated over the dual faces using the weights described in \cite{citeulike:2398873}. To compute the interpolated velocity at some position $x$ on a flat convex polygon with vertices $p_1,...,p_k$, every vertex is assigned a weight $w_j$, depending on $x$. The weight $w_j$ for the vertex $p_j$ is given by: 
\[c_j(x) = \frac{\abs{n_{j1} \times n_{j2}}}{\langle n_{j1}, p_j -x\rangle\cdot\langle n_{j2}, p_j -x\rangle},\]
\[w_j(x) = \frac{c_j}{\sum_{i=1}^k c_i},\]
where $n_{j1}$ and $n_{j2}$ are the normals on the edges incident to $p_j$.
On the edges of the polygon, these weights are linear. Particularly the weights coincide for neighboring polygons, and therefore can be used to produce a vector field without discontinuities between neighboring dual faces. One weight function is depicted in Figure \ref{fig:fd_bariweight}.

On flat meshes these weights can be used directly to interpolated the velocities computed on dual vertices via
\[u(x) = \sum_{j} w_j(x) u_j.\] 
On a curved mesh such an interpolation will not lead to a tangential vector. To simply reproject the interpolated vector on the appropriate triangle leads to a non continous vector field, see Figure \ref{fig:fd_flatteninterpolation}. Therefore, we propose to  flatten  the dual face and the velocities by projecting them along the curvature normal described in \cite{laplacebeltrami} associated to the dual face, do the interpolation with the projected vector field and then project the interpolated vector back to the appropriate triangle. The flattening is given by:

\begin{figure}%
\begin{center}
\includegraphics[height= 3cm]{imgs/8_curvedinterpolation.eps}%	
\end{center}
\caption{On curved meshes dual faces are not flat, they need to be flattened in the interpolation step to get a continuous interpolation of the vector field.}%
\label{fig:fd_flatteninterpolation}%
\end{figure}


\[u_{flat}(x) = \sum (u_j - N_{curv} \langle N_{curv}, u_j \rangle) w_j\]
\[= (\sum u_j w_j )- N_{curv} (\sum \langle N_{curv}, w_j u_j \rangle).\]
And the reprojection onto a triangle $t$ with normal $N_t$ along $N_{curv}$ is given by
\[u(x) = u_{flat}(x) - N_{curv} \frac{\langle u_{flat}(x), N_{t}\rangle}{ \langle N_{curv}, N_t \rangle}.\]

\subsubsection{Pathtracing on a mesh}
Given a continuous vector field on the mesh, the pathtracing step (IS 2 a)) is straight forward to implement. Let $u(x)$ be the interpolated velocity field, then this field can be pathtraced by doing small steps of size $h$ according to $u$. A simple pathtracing algorithm is described in Figure \ref{fig:fd_pathtracing}. 

\begin{figure}
%\caption{backtrace a position}
\begin{center}
\fbox{\parbox{10cm}{
\begin{algorithmic} %\REQUIRE T , stepSize  
\STATE \hspace{-0.3cm}\textbf{backtrace}:
\STATE t = T;
\WHILE {$( t > 0)$}
\STATE backtrace(t, stepSize, pos, triangle);
\ENDWHILE
\STATE
\STATE \hspace{-0.3cm}\textbf{backtrace}(t,stepSize, pos, triangle):
\STATE $u = u(pos, triangle)$;
\STATE $maxT = maxt(pos, triangle, u)$;
\STATE $step = min(t, stepSize, maxT)$
\IF{$step < maxT$}
\STATE $pos += step \cdot u;$
\STATE $t-= step;$
\ENDIF
\IF{triangle boundary reached}
\STATE $triangle = neighborTriangle$; %//or stop tracing if border of the mesh is hit.
\ENDIF
\end{algorithmic}}}
\end{center}
\caption{A straight forward algorithm to trace  the trajectory of a particle. $u(...)$ is the interpolated vector field and $maxt$ is a helper function that computes the maximal possible time step before hitting the border of the current triangle.}
\label{fig:fd_pathtracing}
\end{figure}

\subsubsection{Backtracing Vorticities}

When the dual vertices have been traced back, the vorticity is calculated on the backtraced dual mesh (IS 2 b)). Additional `dual vertices' are introduced on the midpoints of primary border edges such that the dual border faces are complete. These dual vertices are treated separately: as viscous fluids have by definition zero velocity on borders, the midpoints of border edges don't need to be traced back, as they don't move. Their velocity is defined to be zero; this zero velocity is also used when interpolating the velocity field on boundary dual faces. Note that this separate treatment of the dual vertices on the boundary is the reason why obstacles induce vorticity in our simulation. 

On the backtraced dual faces the vorticity is computed by integrating the velocity field along their boundary. If $p_0$,...,$p_n$ are the boundary vertices of the the backtraced dual face this is
\[\sum_{i=0}^n\langle u(p_i) + u(p_{i+1}), p_{i+1}-p_{i}\rangle/2,\]
where $u(p)$ denotes the interpolated velocity field $u$ at the position $p$. A further improvement is to use the harmonic component $\discrete{c}$ of $u$ only if at least one backtraced  dual vertex lies on the boundary of the mesh. By definition a harmonic field has no vorticity and therefore is irrelevant for the vorticity calculation away from obstacle boundaries. But due to floating point errors the vorticity of the harmonic component will never totally vanish. This introduces artifacts, as vorticity erroneously induced by the harmonic field is accumulated over time. Therefore, the calculation of backtraced vorticity on dual boundary faces and dual inner faces is treated separately:

\begin{align*}
&\sum_{i=0}^n\langle d\discrete{a}(p_i) + d\discrete{a}(p_{i+1}), p_{i+1}-p_{i}\rangle/2 & \text{for inner dual faces,}\\
&\sum_{i=0}^n\langle u(p_i) + u(p_{i+1}), p_{i+1}-p_{i}\rangle/2& \text{for boundary dual faces.}
\end{align*}

These are values defined on the dual faces and represent a \emph{dual} 2-form. To get the vorticities as a primary $0$-form they additionally need to be $\star_0^{-1}$-ed.


\subsection{Diffusion and Additional Forces}
\label{ssec:fd_diffusion_and_forces}

After tracing back the vorticities (IS steps 2 a) and b)), the obtained vorticities are diffused (IS step 2 c)) and additional forces are accounted for (IS step 3).
Both, the diffusion of vorticities and addition of forces, are simple and can be implemented directly using the DEC operators. The diffusion of vorticity as described by Equation \ref{eq:vortDiffusion}, i.e.
\[\discrete{w}_{t_{n+1}} = \discrete{w}^{backtraced} + \nu t \Delta \discrete{w}_{t_{n+1}},\]
translates in DEC to solving the following sparse linear system for $\discrete{w}^0_{t_{n+1}}$:
$$(Id - \nu (t_{n+1}-t_n)  \star_0^{-1} d^{dual}_0\star_1d_0)\discrete{w}_{t_{n+1}} = \discrete{w}^{backtraced}.$$
The addition of forces to the vorticities is given by
$$\discrete{w}^{backtraced}_{t_{n+1}} += (t_{n+1}-t_n)\cdot\partial^1_{discrete} \discrete{f}^1.$$


\subsection{The Harmonic Component}
\label{ssec:fd_harmonic}

What is left is the recovery of $u$ from the vorticities, that is IS step 4. This involves the precomputation of a harmonic form and the recovery of the vorticity part $da$. Both computations are related to each other but they occur in different steps in the algorithm. The computation of the harmonic component occurs only once during a set up step and the recovery of $da$ occurs once in every time step (IS step 4).

In the vector design chapter we already introduced methods to compute harmonic vector fields on meshes with boundaries. But the constraints derived here lead to solutions with a quality superior to the harmonic forms obtained using the adapted matrices from the vector design chapter.

\subsubsection{Harmonic Forms and Cycles}
In Section \ref{subsec:vf_dimHarm} we have seen that the problem statement '$\omega^1$ is harmonic` has degrees of freedom depending only on the topology of the manifold. The following result mentioned in \cite{FRANKEL11} (p377) explains these degrees of freedom for 1-forms on borderless manifolds, and \emph{tangential} 1-forms on manifolds with boundary. Note that the result is formulated more generally in \cite{FRANKEL11}, treating harmonic $k$-forms ans using the notion of $k$-cycles.

\begin{thm}
Let $M$ be a compact manifold with boundary. Let $z_1,...,z_\beta$ be a basis of 1-cycles on the manifold. Then there exists a unique tangent harmonic 1-form $\alpha^1$ with prescribed periods $p_1,...,p_{\beta}$
\[\int_{z_1}\alpha^1 = p_1\]
\[\int_{z_2}\alpha^1 =p_2\]
\[...\]
\[\int_{z_\beta}\alpha^1 = p_{\beta}\]
\end{thm}

For a correct definition of cycles see \cite{FRANKEL11}. A basis of $1$-cycles is basically a set of closed curves from which you can build any closed curve on the manifold by concatenation. In Figure \ref{fig:fd_cycles} a torus and a bordered manifold are depicted on which two cycles form the basis of 1-cycles. On these manifolds a harmonic tangential differential 1-form is well defined if the flow along the two cycles, i.e. the period on the two cycles, is fixed. 

\begin{figure}%
\begin{center}
\includegraphics[height = 3cm]{imgs/8_cyclebases.eps}%	
\end{center}
\caption{Harmonicity for tangential 1-form on a 2-manifold has as many degrees of freedom as there are elements in a cycle basis of the manifold. %The degrees of freedom are fixed by fixing the periods of the 1-form on a basis of cycles. 
On the torus and the bordered manifold depicted here cycle bases have two elements.
A harmonic tangential 1-form is uniquely defined if the flow along the basis cycles is fixed. }%
\label{fig:fd_cycles}%
\end{figure}


On manifolds without boundaries one additional constraint is needed for each 1-cycle in the basis of 1-cycles for the computation of a harmonic component. On objects with sphere topology there is no need to compute any harmonic component, as the space of harmonic 1-forms is zero dimensional---there are no harmonic 1-forms on spheres. 

The only type of meshes with boundary we consider are flat meshes with one or more holes that describe impenetrable obstacles, like the one depicted in Figure \ref{fig:fd_harmconstraints}.


\subsubsection{Computing the Harmonic Component on Flat Bordered Meshes}

We assume that all inner boundaries describe obstacles and only the outer boundary has sections that allow flow to pass. We now design a set of constraints for the computation of the harmonic component of the flow. The goal is to find a harmonic 1-form with
\begin{align}
\partial \textbf{c} &= 0 & \text{(zero vorticity)}\nonumber\\ 
d \textbf{c} &= 0 & \text{(zero divergence)}\nonumber\\
\textbf{c} &= 0 & \text{on inner boundaries}\nonumber\\
\textbf{c} &= \textbf{u} & \text{on the exterior boundary}
\label{eq:fd_harmonic}
\end{align}
The constraints $\textbf{u}$ on the exterior border can not be chosen arbitrarily. At the very least summing up the flux over the exterior border should be zero, else the zero divergence condition is impossible to fulfill. A simple consistent constraint can be obtained by choosing a fixed direction $v$ and setting all edges of the exterior boundary to
\begin{equation}\discrete{c}(edge) = \langle edge^\perp, v\rangle=: \discrete{u}(edge) \label{eq:fspermeable}.\end{equation}


\begin{figure}%
\begin{center}
\includegraphics[height = 3cm]{imgs/8_constraints.eps}%	
\end{center}
\caption{Example constraints for a harmonic component. The period around every obstacle has to be fixed by fixing the flow along the blue circles. The exterior boundary allows incoming flow on one side and outgoing flow on the other, following Equation \ref{eq:fspermeable}. All other boundaries allow no flux.}%
\label{fig:fd_harmconstraints}%
\end{figure}


Constraining only the values on boundaries does not get rid of all degrees of freedom. For any two solutions $v$, $w$ of the system \ref{eq:fd_harmonic}, the difference $v-w$ is a $1$-form tangential on all boundaries. Therefore, the theorem described in the last section applies to the difference of solutions. 
In particular this means that if the system \ref{eq:fd_harmonic} has a solution, there exists a solution with arbitrary prescribed periods on a system of independent cycles. 

%At the moment we ignore the exterior boundary. The inner boundaries are impenetrable, the flow on their boundaries has to be tangential and the theorem described in the last section applies. 
Every inner border introduces one new cycle and an additional degree of freedom. Therefore for every obstacle one additional constraint has to be provided that fixes the period around the obstacles. We will constrain these periods to be zero. The overall constraints are depicted in Figure \ref{fig:fd_harmconstraints}.


\begin{figure}%
\begin{center}
\includegraphics[height = 3.5cm]{imgs/8_dualborderface.eps}%	
\end{center}
\caption{The border vertices of the inner border (red) are interpreted as one vertex with a single dual face (blue).}%
\label{fig:fd_dualborderface}%
\end{figure}

These constraints can be enforced by slightly changing the dual mesh and adapting the DEC matrices. The dual mesh is changed in the following way: the vertices on an inner border are interpreted as one vertex and their dual faces are combined to one single dual face, as depicted in Figure \ref{fig:fd_dualborderface}. The boundary of this dual face is the closed cycle on which the zero periodicity is enforced. 

The dual derivative computes the flow around dual faces. Therefore, if it is adapted according to the changed dual mesh, the zero vorticity constraint for harmonic 1-forms,
\[\widetilde{d^{dual}_1} \star_1 \textbf{c} =0,\]
naturally enforces a zero period around inner borders. The dual derivative $d_1^{dual}$ is adapted by adding one line per border component,
\[\widetilde{d_1^{dual}} = \begin{pmatrix} d_1^{dual} \\
(1_{border_1})^T \cdot d_1^{dual} \\
\vdots \\
(1_{border_k})^T \cdot d_1^{dual} \\
\end{pmatrix},\]
and dropping the matrix columns corresponding to the dual faces of single boundary vertices. Equivalently the corresponding values of $\star_0$ can be set to zero, as we only consider $\widetilde{d_1^{dual}}^t\star^0 \widetilde{d_1^{dual}}$.
Additionally some positive dual primal weights $W$ for the newly composed dual faces have to be appended to $\star_0$. The weight $W$ can be chosen to be the combined area of the dual faces of border vertices, but any positive weights will work. This leads to
\[\widetilde{\star_0} = \begin{pmatrix}\star_0& & &\\
&W& &\\
& &\ddots &\\
& & & W \end{pmatrix}.\]


With these adapted matrices and $\widetilde{\partial}$ denoting $\partial$ expressed with the adapted matrices, the system \ref{eq:fd_harmonic} can be solved by solving
\begin{equation}\begin{pmatrix} d^T & \widetilde{\partial}^T & Id_{border}^T \end{pmatrix} \begin{pmatrix}
\star_2 & & \\
 & \widetilde{\star_0} & \\
 & & \lambda
\end{pmatrix} \begin{pmatrix} d \\
\widetilde{\partial}\\
Id_{border}
\end{pmatrix} \discrete{c}^1= \lambda\discrete{u}.\label{eq:fsharmonic}\end{equation}
Here $\lambda$ is a positive weight for the boundary constraints and $\discrete{u}$ is zero on inner edges and the chosen constraint on the exterior boundary, for example given by Equation \ref{eq:fspermeable}. 

\subsection{Recovering $d\textbf{a}$}
\label{ssec:fd_recovering_da}

With the precomputed harmonic component $\discrete{c}$ in place, we can describe the last step of the integration scheme, step 4, the recovery of the velocity field from vorticities alone.

\pagebreak
The last missing element, the reconstruction of the vorticity part $d\discrete{a}$ from the vorticities $\discrete{w}$ works as described in Theorem \ref{thm:vort2vel} in Section \ref{subsec:fd_vort2vel}, by solving 
\begin{align}\Delta \discrete{a}^1 = \discrete{w}^0_{t_{n+1}}\label{eq:fd_discreteVort2Vel},\end{align}
and setting
\begin{align}
\discrete{v}^1_{updated} =  d_0 \discrete{a}^1 + \discrete{c}^1.\end{align}
There is one hick up. The condition of the theorem is that consistent DEC matrices are used that allow a Hodge decomposition, such that the harmonic component $\discrete{c}$ is orthogonal to $d\discrete{a}$. 

The harmonic component is computed with adapted DEC matrices and by additionally enforcing some values on the outer border.  These constraints on the exterior boundary actually introduce new 'cycles` and fix the additional periods of the harmonic form. These additional `cycles' and their number depends on the boundary constraint, see Figure \ref{fig:fd_boundaryinducedCycles}.


\begin{figure}[t]%
\begin{center}
\includegraphics[height=3.5cm]{imgs/8_boundaryconstraintsInduceCycles}%	
\end{center}
\caption{The constraints on the exterior boundary induce new `cycles' (red) on which the period of the harmonic form is non-zero. How these cycles look and how many there are depends on the boundary condition. A vorticity part $d\discrete{a}$ has to be constrained to have a zero period along these induced cycles, else it is not orthogonal to the harmonic form.}%
\label{fig:fd_boundaryinducedCycles}%
\end{figure}

For $da$ to be orthogonal to $c$, $\partial d a = 0$ should enforce that $da$ has a zero period on all cycles where $c$ has a non zero period. Applying $\partial$ to $da$ sums up the flow of $da$ around dual faces. As the cycles induced by the exterior boundary constraint are not accounted in the DEC matrix $\partial$, $\partial d a = 0$ fails to enforce zero periodicity on them. While the correct thing would be to identify such induced cycles and add additional constraints on them, a much simpler approach is to add the constraint $da = 0$ on \emph{all} boundary edges, this seems also to be the approach taken in \cite{simplicialFluids}. This constraint can be enforced by additionally minimizing $\mu\; (d^TId_{boundaryedges} d)\cdot a$ for some large weight $\mu \in \mathbb R$, which leads to the equation
\begin{equation}(\Delta + \mu(d^T Id_{boundaryedges} d)) \discrete{a}^1 = \discrete{w}^0_{t_{n+1}},\end{equation}
\begin{equation}\discrete{v}^1_{updated} =  d_0 \discrete{a}^1 + \discrete{c}^1.\end{equation}

This leads to a slightly incorrect behavior close to boundaries presumed to be permeable: in this vorticity reconstruction step they are treated like obstacle boundaries, they will reflect flow. But if the permeable boundaries are in regions with no vorticity or they are sufficiently far away from the areas of interest, this can be ignored.


%The harmonic component is computed with adapted DEC matrices and by additionally enforcing some values on the outer border. The additional enforcement of fluxes on the outer border are a bit of a hack. They make it necessary to enforce boundary constraints during the recovery of $d\discrete{a}$ as well. These constraints on the exterior boundary actually fix the period of the harmonic form on bordered meshes but this is kind of very application dependent. in the example showed here we can reduce the problem to a problem with only inpenetrable walls and the harmonic form has two free periods that can be chosen. The inner one for the obstacle is enforced correctly by adapting the DEC matrix, the outer one is replaced by fixing the boundary values and thereby fixing the period. But these boundary constraints are then not reflected in the DEC matrices as they should and therefore the Hodge decomposition does not work. The problem in example would be that divergence along the object is not taken into account. The correct thing would be to enforce a zero periodicity but we and the authors of ... simply enforce a zero flux constraint on all boundaries, thereby fixing the period as well and guaranteeing orthogonality. Nevertheless this leads to a slightly incorrect behavior on penetrable boundaries.

%This leads to a slightly incorrect behavior on pesumedly durchlaessigen kanten. For the vorticity reconstruction and the ... spiegeln, bild. But this effect is not important in the example displayed... as boundary a has nothing to mirror, the vorticities being zero and boundary 2 is far away enough from the obstacle not to influence the ....

%\[\]
%\[\]
%We now translate the vector calculus equation \ref{eq:NS3} and the integration scheme into DEC terms. 
%The velocity field $u$ is described as a discrete  $1$-form $\discrete{v}^1$, as are the user provided forces $\discrete{f}^1$ and the precomputed harmonic part of the flow $\discrete{c}^1$. %But instead of associating $\discrete{v}^1$ to the velocity $u$ as representing flows along edges according to the first sampling scheme described in \note{...} $\discrete{v}^1$ is associated to $u$ using the second sampling scheme \note{...} where $\discrete{v}^1$ describes the flux through the edges. In comparison to the vector field design implementation the roles of the dual and primary mesh gets switched, what were the discrete dual forms are now stored on the primary mesh. Accordingly the role of the operators $d$ and $\partial$ switch, as depicted in the schematic \note{img: Todo standard operators and relation to ec now}.
%%The reason to chose to represent the velocity field by fluxes on the primary mesh is that it greatly facilitates the enforcement of border constrains. Boundaries of obstacles then simply consist of edges, where no flux passes, i.e. $\discrete{v}^1$ will be constrained to $\discrete{v}^1(e_{obstacle}) = 0$. \note{img}.
%
%The vorticity of $u$  is a discrete $0$-form $ \discrete{w}^0 = \delta_{discrete}^1 \discrete{v}^{1}$, consisting of values defined on vertices. Steps $(2a)$ and $(2b)$ of the integration scheme, i.e. the backtracking of parcels and computation of vorticities are described in the next section. All other parts of the numerical integration are straight forward to translate. The step $(2 c)$, the diffusion of vorticity as given by the Equation \ref{eq:vortDiffusion},
%\[\discrete{w}^0_{t_{n+1}} = \discrete{w}^0 + \nu t \Delta \discrete{w}^0_{t_{n+1}}\]
%i.e.
%\begin{equation}(Id - \nu t  \star_0 d^{dual}_0\star_1d_0)\discrete{w}^0_{t_{n+1}} = \discrete{w}^0 \label{eq:fd_discreteDiffusion}\end{equation}
%The step $(3)$, the addition of forces is given by
%\begin{equation}\discrete{w}^0_{t_{n+1}} += \partial^1_{discrete} \discrete{f}^1\end{equation}
%The step $(4)$, the reconstruction of the updated $1$-form $\discrete{v}^1$ works as described in Theorem \ref{thm:vort2vel} in Section \ref{subsec:fd_vort2vel}: \note{enforce 0 border flux ....}
%\begin{equation}\Delta \discrete{a}^1 = \discrete{w}^0_{t_{n+1}}\end{equation}
%\begin{equation}\discrete{v}^1_{updated} =  d_0 \discrete{a}^1 + \discrete{c}^1\end{equation}
%where $c$ is the precomputed harmonic solution, $\Delta$ is the discrete Laplacian. Equations \ref{eq:fd_discreteDiffusion} and \ref{eq:fd_discreteVort2Vel} are to be solved with a sparse solver.



\section{Results}

The algorithm gives plausible results if the meshes are of good quality. Because Voronoi duality is used and the dual mesh is used explicitly, all triangles have to be non-obtuse. The algorithm was tested on spheres and on flat meshes with one obstacle. Both  were generated such that there are no obtuse triangles. The quality of the results is much increased if the meshes have a higher resolution around the obstacles, as the most complex processes happen there. All flat meshes used are adaptive meshes, generated with the Matlab tool described in \cite{meshmatlab}, like the mesh displayed in Figure \ref{fig:fd_meshes}.


\begin{figure}%
\begin{center}
\includegraphics[height = 3cm]{imgs/8_adaptivemesh1p4k.eps}%	
\end{center}
\caption{An adaptive mesh generated with \cite{meshmatlab} in Matlab, with 1 400 faces.}%
\label{fig:fd_meshes}%
\end{figure}

It is hard to tell how accurate the simulations are. The time step size and the sampling density of the mesh have a huge influence on the simulation. As in every step velocities are interpolated, each time step induces some unwanted diffusion. The sparser the mesh is, the more diffusion is introduced by the interpolation in every step. Choosing a larger time step reduces this effect but also leads to less exact numerical integration; and if the steps are too large, the simulation becomes unstable. 

In Figure \ref{fig:fd_timevsmesh} the influence of the time step size and the mesh density are demonstrated. On meshes with a low sample density the result is governed by the diffusion introduced by the interpolation and higher time steps pay off; on meshes with a high vertex density the higher time steps already lead to unstable behavior. Figure \ref{fig:fd_timesteps} shows the influence of the time step size on a single mesh.


\begin{figure}%
\includegraphics[width=\columnwidth]{imgs/8_results_timestepvsmeshsize.eps}%
\caption{The algorithm was run with different time step sizes on meshes with different densities, while keeping the vorticity fixed. The velocity from left to right is 10 units per second and the mesh is 2 units wide. The time step size, listed from left to right, was selected to be 0.025, 0.005 and 0.075. The meshes have, listed from top to bottom, 1 400, 2 800, 5 300 and 12 000 faces. All meshes are adaptive and were generated using the same vertex distribution as for the mesh in Figure \ref{fig:fd_meshes}.
The meshes are colored with the vorticity of the flow. Gray is a low absolute vorticity, light blue denotes high counter clockwise vorticity and yellow denotes high clockwise velocity.
}%
\label{fig:fd_timevsmesh}%
\end{figure}

\begin{figure}%
\includegraphics[width=\columnwidth]{imgs/8_results_timesteps.eps}%
\caption{On a mesh with 12 000 faces the time step was varied while keeping the viscosity at $0.02$. Velocity and coloring are the same as in Figure \ref{fig:fd_timevsmesh}. The behavior of the simulation depends on the time step; for the time step of 0.0075 the simulation begins to be unstable.}%
\label{fig:fd_timesteps}%
\end{figure}

For an optimal solution the size of the time step would have to be adapted to the mesh resolution such that the two influences, additional diffusion and incorrect integration, are minimal.
Independently the viscosity $\nu$ can be varied and controls the diffusion rather well, as depicted in Figure \ref{fig:fd_viscosities}.

\begin{figure}%
\includegraphics[width=\columnwidth]{imgs/8_results_viscosities.eps}%
\caption{On a mesh with 12 000 faces the viscosity was varied while keeping the time step at $0.02$. Velocity and coloring are the same as in Figure \ref{fig:fd_timevsmesh}.}%
\label{fig:fd_viscosities}%
\end{figure}

Apart from the simulation being highly dependent on the mesh and time step, visually interesting results can be achieved by tweaking the parameters. And the simulation works well on curved meshes, as for example the simulation on the sphere in Figure \ref{fig:fd_sphere}.

\begin{figure}%
\includegraphics[width=\columnwidth]{imgs/8_fluidsphere_demo.eps}%
\caption{A fluid simulation on a sphere with about 1500 faces. The timestep was selected to be 0.005 and motion was induced by stirring, the viscosity was set to 0.03. }%
\label{fig:fd_sphere}%
\end{figure}


